
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"><meta content="Collect useful snippets of c extensions" lang="en" name="description" xml:lang="en" />
<meta content="Python, Python3, Python C Extensions, Python C Extensions Cheat Sheet" name="keywords" />

    <title>C Extensions &#8212; pysheeet</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../_static/carbonad.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Why does Decorator Need @wraps" href="../appendix/python-decorator.html" />
    <link rel="prev" title="Test" href="python-tests.html" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="canonical" href="https://www.pythonsheets.com/notes/python-c-extensions.html"/>
<meta property="og:url" content="https://www.pythonsheets.com/notes/python-c-extensions.html">
<meta property="og:type" content="article">
<meta property="og:title" content="C Extensions &#8212; pysheeet">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-127044388-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-127044388-1');
</script>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="c-extensions">
<h1>C Extensions<a class="headerlink" href="#c-extensions" title="Permalink to this headline">¶</a></h1>
<p>Occasionally, it is unavoidable for pythoneers to write a C extension. For
example, porting C libraries or new system calls to Python requires to
implement new object types through C extension. In order to provide a brief
glance on how C extension works. This cheat sheet mainly focuses on writing a
Python C extension.</p>
<p>Note that the C extension interface is specific to official CPython. It is
likely that extension modules do not work on other Python implementations
such as <a class="reference external" href="https://pypy.org/">PyPy</a>. Even if official CPython, the Python
C API may be not compatible with different versions, e.g., Python2 and Python3.
Therefore, if extension modules are considered to be run on other Python
interpreters, it would be better to use <a class="reference external" href="https://docs.python.org/3/library/ctypes.html">ctypes</a>
module or <a class="reference external" href="https://cffi.readthedocs.io/en/latest/">cffi</a>.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#c-extensions" id="id1">C Extensions</a></p>
<ul>
<li><p><a class="reference internal" href="#simple-setup-py" id="id2">Simple setup.py</a></p></li>
<li><p><a class="reference internal" href="#customize-cflags" id="id3">Customize CFLAGS</a></p></li>
<li><p><a class="reference internal" href="#doc-string" id="id4">Doc String</a></p></li>
<li><p><a class="reference internal" href="#simple-c-extension" id="id5">Simple C Extension</a></p></li>
<li><p><a class="reference internal" href="#release-the-gil" id="id6">Release the GIL</a></p></li>
<li><p><a class="reference internal" href="#acquire-the-gil" id="id7">Acquire the GIL</a></p></li>
<li><p><a class="reference internal" href="#get-reference-count" id="id8">Get Reference Count</a></p></li>
<li><p><a class="reference internal" href="#parse-arguments" id="id9">Parse Arguments</a></p></li>
<li><p><a class="reference internal" href="#calling-python-functions" id="id10">Calling Python Functions</a></p></li>
<li><p><a class="reference internal" href="#raise-exception" id="id11">Raise Exception</a></p></li>
<li><p><a class="reference internal" href="#customize-exception" id="id12">Customize Exception</a></p></li>
<li><p><a class="reference internal" href="#iterate-a-list" id="id13">Iterate a List</a></p></li>
<li><p><a class="reference internal" href="#iterate-a-dictionary" id="id14">Iterate a Dictionary</a></p></li>
<li><p><a class="reference internal" href="#simple-class" id="id15">Simple Class</a></p></li>
<li><p><a class="reference internal" href="#simple-class-with-members-and-methods" id="id16">Simple Class with Members and Methods</a></p></li>
<li><p><a class="reference internal" href="#simplie-class-with-getter-and-setter" id="id17">Simplie Class with Getter and Setter</a></p></li>
<li><p><a class="reference internal" href="#inherit-from-other-class" id="id18">Inherit from Other Class</a></p></li>
<li><p><a class="reference internal" href="#run-a-python-command" id="id19">Run a Python Command</a></p></li>
<li><p><a class="reference internal" href="#run-a-python-file" id="id20">Run a Python File</a></p></li>
<li><p><a class="reference internal" href="#import-a-python-module" id="id21">Import a Python Module</a></p></li>
<li><p><a class="reference internal" href="#import-everything-of-a-module" id="id22">Import everything of a Module</a></p></li>
<li><p><a class="reference internal" href="#access-attributes" id="id23">Access Attributes</a></p></li>
<li><p><a class="reference internal" href="#performance-of-c-extension" id="id24">Performance of C Extension</a></p></li>
<li><p><a class="reference internal" href="#performance-of-ctypes" id="id25">Performance of ctypes</a></p></li>
<li><p><a class="reference internal" href="#ctypes-error-handling" id="id26">ctypes Error handling</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="simple-setup-py">
<h2>Simple setup.py<a class="headerlink" href="#simple-setup-py" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span>

<span class="n">ext</span> <span class="o">=</span> <span class="n">Extension</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;foo.c&#39;</span><span class="p">])</span>
<span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="n">ext_modules</span><span class="o">=</span><span class="p">[</span><span class="n">ext</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="customize-cflags">
<h2>Customize CFLAGS<a class="headerlink" href="#customize-cflags" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sysconfig</span>
<span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span>

<span class="n">cflags</span> <span class="o">=</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">get_config_var</span><span class="p">(</span><span class="s2">&quot;CFLAGS&quot;</span><span class="p">)</span>

<span class="n">extra_compile_args</span> <span class="o">=</span> <span class="n">cflags</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">extra_compile_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-Wextra&quot;</span><span class="p">]</span>

<span class="n">ext</span> <span class="o">=</span> <span class="n">Extension</span><span class="p">(</span>
    <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;foo.c&quot;</span><span class="p">],</span>
    <span class="n">extra_compile_args</span><span class="o">=</span><span class="n">extra_compile_args</span>
<span class="p">)</span>

<span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="n">ext_modules</span><span class="o">=</span><span class="p">[</span><span class="n">ext</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="doc-string">
<h2>Doc String<a class="headerlink" href="#doc-string" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyDoc_STRVAR</span><span class="p">(</span><span class="n">doc_mod</span><span class="p">,</span> <span class="s">&quot;Module document</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">PyDoc_STRVAR</span><span class="p">(</span><span class="n">doc_foo</span><span class="p">,</span> <span class="s">&quot;foo() -&gt; None</span><span class="se">\n\n</span><span class="s">Foo doc&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">foo</span><span class="p">,</span> <span class="n">METH_NOARGS</span><span class="p">,</span> <span class="n">doc_foo</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">m_base</span>    <span class="o">=</span> <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
    <span class="p">.</span><span class="n">m_name</span>    <span class="o">=</span> <span class="s">&quot;Foo&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">m_doc</span>     <span class="o">=</span> <span class="n">doc_mod</span><span class="p">,</span>
    <span class="p">.</span><span class="n">m_size</span>    <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">.</span><span class="n">m_methods</span> <span class="o">=</span> <span class="n">methods</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="simple-c-extension">
<h2>Simple C Extension<a class="headerlink" href="#simple-c-extension" title="Permalink to this headline">¶</a></h2>
<p>foo.c</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="n">PyDoc_STRVAR</span><span class="p">(</span><span class="n">doc_mod</span><span class="p">,</span> <span class="s">&quot;Module document</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">PyDoc_STRVAR</span><span class="p">(</span><span class="n">doc_foo</span><span class="p">,</span> <span class="s">&quot;foo() -&gt; None</span><span class="se">\n\n</span><span class="s">Foo doc&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">PyObject</span><span class="o">*</span> <span class="nf">foo</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span> <span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">s</span> <span class="o">=</span> <span class="n">PyUnicode_FromString</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
    <span class="n">PyObject_Print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">foo</span><span class="p">,</span> <span class="n">METH_NOARGS</span><span class="p">,</span> <span class="n">doc_foo</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;Foo&quot;</span><span class="p">,</span> <span class="n">doc_mod</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span> <span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ python -c <span class="s2">&quot;import foo; foo.foo()&quot;</span>
<span class="s1">&#39;foo&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="release-the-gil">
<h2>Release the GIL<a class="headerlink" href="#release-the-gil" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="n">PyObject</span><span class="o">*</span> <span class="nf">foo</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span> <span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">foo</span><span class="p">,</span> <span class="n">METH_NOARGS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;Foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span> <span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ python -c <span class="s2">&quot;</span>
<span class="s2">&gt; import threading</span>
<span class="s2">&gt; import foo</span>
<span class="s2">&gt; from datetime import datetime</span>
<span class="s2">&gt; def f(n):</span>
<span class="s2">&gt;     now = datetime.now()</span>
<span class="s2">&gt;     print(f&#39;{now}: thread {n}&#39;)</span>
<span class="s2">&gt;     foo.foo()</span>
<span class="s2">&gt; ts = [threading.Thread(target=f, args=(n,)) for n in range(3)]</span>
<span class="s2">&gt; [t.start() for t in ts]</span>
<span class="s2">&gt; [t.join() for t in ts]&quot;</span>
<span class="m">2018</span>-11-04 <span class="m">20</span>:15:34.860454: thread <span class="m">0</span>
<span class="m">2018</span>-11-04 <span class="m">20</span>:15:34.860592: thread <span class="m">1</span>
<span class="m">2018</span>-11-04 <span class="m">20</span>:15:34.860705: thread <span class="m">2</span>
</pre></div>
</div>
<p>In C extension, blocking I/O should be inserted into a block which is wrapped by
<code class="docutils literal notranslate"><span class="pre">Py_BEGIN_ALLOW_THREADS</span></code> and <code class="docutils literal notranslate"><span class="pre">Py_END_ALLOW_THREADS</span></code> for releasing the GIL
temporarily; Otherwise, a blocking I/O operation has to wait until previous
operation finish. For example</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="n">PyObject</span><span class="o">*</span> <span class="nf">foo</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span> <span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">foo</span><span class="p">,</span> <span class="n">METH_NOARGS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;Foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span> <span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python -c <span class="s2">&quot;</span>
<span class="s2">&gt; import threading</span>
<span class="s2">&gt; import foo</span>
<span class="s2">&gt; from datetime import datetime</span>
<span class="s2">&gt; def f(n):</span>
<span class="s2">&gt;     now = datetime.now()</span>
<span class="s2">&gt;     print(f&#39;{now}: thread {n}&#39;)</span>
<span class="s2">&gt;     foo.foo()</span>
<span class="s2">&gt; ts = [threading.Thread(target=f, args=(n,)) for n in range(3)]</span>
<span class="s2">&gt; [t.start() for t in ts]</span>
<span class="s2">&gt; [t.join() for t in ts]&quot;</span>
<span class="m">2018</span>-11-04 <span class="m">20</span>:16:44.055932: thread <span class="m">0</span>
<span class="m">2018</span>-11-04 <span class="m">20</span>:16:47.059718: thread <span class="m">1</span>
<span class="m">2018</span>-11-04 <span class="m">20</span>:16:50.063579: thread <span class="m">2</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The GIL can only be safely released when there is <strong>NO</strong> Python C API
functions between <code class="docutils literal notranslate"><span class="pre">Py_BEGIN_ALLOW_THREADS</span></code> and <code class="docutils literal notranslate"><span class="pre">Py_END_ALLOW_THREADS</span></code>.</p>
</div>
</div>
<div class="section" id="acquire-the-gil">
<h2>Acquire the GIL<a class="headerlink" href="#acquire-the-gil" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">sec</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">py_callback</span><span class="p">;</span>
<span class="p">}</span> <span class="n">foo_args</span><span class="p">;</span>

<span class="kt">void</span> <span class="o">*</span>
<span class="nf">foo_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">rv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">sec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span><span class="o">*</span> <span class="n">py_callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">foo_args</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">foo_args</span> <span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">;</span>
    <span class="n">sec</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">;</span>
    <span class="n">py_callback</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">py_callback</span><span class="p">;</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">PyLong_AsLong</span><span class="p">(</span><span class="n">sec</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">PyErr_Occurred</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">sleep</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>  <span class="c1">// slow task</span>

    <span class="c1">// acquire the GIL</span>
    <span class="n">PyGILState_STATE</span> <span class="n">state</span> <span class="o">=</span> <span class="n">PyGILState_Ensure</span><span class="p">();</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">PyObject_CallFunction</span><span class="p">(</span><span class="n">py_callback</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;Awesome Python!&quot;</span><span class="p">);</span>
    <span class="c1">// release the GIL</span>
    <span class="n">PyGILState_Release</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">rv</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">foo</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pthread_t</span> <span class="o">*</span><span class="n">arr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">py_callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">sec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">rv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">foo_args</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;OOO:callback&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">py_callback</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// allow releasing GIL</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyLong_Check</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">PyLong_Check</span><span class="p">(</span><span class="n">num</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_TypeError</span><span class="p">,</span> <span class="s">&quot;should be int&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyCallable_Check</span><span class="p">(</span><span class="n">py_callback</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_TypeError</span><span class="p">,</span> <span class="s">&quot;should be callable&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">PyLong_AsLong</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">PyErr_Occurred</span><span class="p">())</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pthread_t</span> <span class="o">*</span><span class="p">)</span><span class="n">PyMem_RawCalloc</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pthread_t</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arr</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="n">a</span><span class="p">.</span><span class="n">sec</span> <span class="o">=</span> <span class="n">sec</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">py_callback</span> <span class="o">=</span> <span class="n">py_callback</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">foo_thread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_TypeError</span><span class="p">,</span> <span class="s">&quot;create a thread failed&quot;</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pthread_join</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_TypeError</span><span class="p">,</span> <span class="s">&quot;thread join failed&quot;</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">Py_XINCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="nl">error</span><span class="p">:</span>
    <span class="n">PyMem_RawFree</span><span class="p">(</span><span class="n">arr</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">sec</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">py_callback</span><span class="p">);</span>
    <span class="c1">// restore GIL</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">foo</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span> <span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ pyton -q
&gt;&gt;&gt; import foo
&gt;&gt;&gt; from datetime import datetime
&gt;&gt;&gt; def cb<span class="o">(</span>s<span class="o">)</span>:
...     <span class="nv">now</span> <span class="o">=</span> datetime.now<span class="o">()</span>
...     print<span class="o">(</span>f<span class="s1">&#39;{now}: {s}&#39;</span><span class="o">)</span>
...
&gt;&gt;&gt; foo.foo<span class="o">(</span><span class="m">3</span>, <span class="m">1</span>, cb<span class="o">)</span>
<span class="m">2018</span>-11-05 <span class="m">09</span>:33:50.642543: Awesome Python!
<span class="m">2018</span>-11-05 <span class="m">09</span>:33:50.642634: Awesome Python!
<span class="m">2018</span>-11-05 <span class="m">09</span>:33:50.642672: Awesome Python!
</pre></div>
</div>
<p>If threads are created from C/C++, those threads do not hold the GIL. Without
acquiring the GIL, the interpreter cannot access Python functions safely. For
example</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="o">*</span>
<span class="nf">foo_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// without acquiring the GIL</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">PyObject_CallFunction</span><span class="p">(</span><span class="n">py_callback</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;Awesome Python!&quot;</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">rv</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; import foo
&gt;&gt;&gt; from datetime import datetime
&gt;&gt;&gt; def cb<span class="o">(</span>s<span class="o">)</span>:
...     <span class="nv">now</span> <span class="o">=</span> datetime.now<span class="o">()</span>
...     print<span class="o">(</span>f<span class="s2">&quot;{now}: {s}&quot;</span><span class="o">)</span>
...
&gt;&gt;&gt; foo.foo<span class="o">(</span><span class="m">1</span>, <span class="m">1</span>, cb<span class="o">)</span>
<span class="o">[</span><span class="m">2</span><span class="o">]</span>    <span class="m">8590</span> segmentation fault  python -q
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>In order to call python function safely, we can simply warp <strong>Python Functions</strong>
between <code class="docutils literal notranslate"><span class="pre">PyGILState_Ensure</span></code> and <code class="docutils literal notranslate"><span class="pre">PyGILState_Release</span></code> in C extension code.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PyGILState_STATE</span> <span class="n">state</span> <span class="o">=</span> <span class="n">PyGILState_Ensure</span><span class="p">();</span>
<span class="c1">// Perform Python actions</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">PyObject_CallFunction</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
<span class="c1">// Error handling</span>
<span class="n">PyGILState_Release</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="get-reference-count">
<h2>Get Reference Count<a class="headerlink" href="#get-reference-count" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">getrefcount</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyLong_FromSsize_t</span><span class="p">(</span><span class="n">Py_REFCNT</span><span class="p">(</span><span class="n">a</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;getrefcount&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">getrefcount</span><span class="p">,</span> <span class="n">METH_O</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span> <span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ python -q
&gt;&gt;&gt; import sys
&gt;&gt;&gt; import foo
&gt;&gt;&gt; <span class="nv">l</span> <span class="o">=</span> <span class="o">[</span><span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span><span class="o">]</span>
&gt;&gt;&gt; sys.getrefcount<span class="o">(</span>l<span class="o">[</span><span class="m">0</span><span class="o">])</span>
<span class="m">104</span>
&gt;&gt;&gt; foo.getrefcount<span class="o">(</span>l<span class="o">[</span><span class="m">0</span><span class="o">])</span>
<span class="m">104</span>
&gt;&gt;&gt; <span class="nv">i</span> <span class="o">=</span> l<span class="o">[</span><span class="m">0</span><span class="o">]</span>
&gt;&gt;&gt; sys.getrefcount<span class="o">(</span>l<span class="o">[</span><span class="m">0</span><span class="o">])</span>
<span class="m">105</span>
&gt;&gt;&gt; foo.getrefcount<span class="o">(</span>l<span class="o">[</span><span class="m">0</span><span class="o">])</span>
<span class="m">105</span>
</pre></div>
</div>
</div>
<div class="section" id="parse-arguments">
<h2>Parse Arguments<a class="headerlink" href="#parse-arguments" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">foo</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">bar</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">baz</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;OO&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;OO&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">qux</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keywords</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTupleAndKeywords</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span>
                                     <span class="s">&quot;O|O&quot;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span>
                                     <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">Py_None</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;OO&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">foo</span><span class="p">,</span> <span class="n">METH_NOARGS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;bar&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">bar</span><span class="p">,</span> <span class="n">METH_O</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;baz&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">baz</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;qux&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">qux</span><span class="p">,</span> <span class="n">METH_VARARGS</span> <span class="o">|</span> <span class="n">METH_KEYWORDS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span> <span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ python -q
&gt;&gt;&gt; import foo
&gt;&gt;&gt; foo.foo<span class="o">()</span>
&gt;&gt;&gt; foo.bar<span class="o">(</span><span class="m">3</span>.7<span class="o">)</span>
<span class="m">3</span>.7
&gt;&gt;&gt; foo.baz<span class="o">(</span><span class="m">3</span>, <span class="m">7</span><span class="o">)</span>
<span class="o">(</span><span class="m">3</span>, <span class="m">7</span><span class="o">)</span>
&gt;&gt;&gt; foo.qux<span class="o">(</span><span class="m">3</span>, <span class="nv">y</span><span class="o">=</span><span class="m">7</span><span class="o">)</span>
<span class="o">(</span><span class="m">3</span>, <span class="m">7</span><span class="o">)</span>
&gt;&gt;&gt; foo.qux<span class="o">(</span><span class="nv">x</span><span class="o">=</span><span class="m">3</span>, <span class="nv">y</span><span class="o">=</span><span class="m">7</span><span class="o">)</span>
<span class="o">(</span><span class="m">3</span>, <span class="m">7</span><span class="o">)</span>
&gt;&gt;&gt; foo.qux<span class="o">(</span><span class="nv">x</span><span class="o">=</span><span class="m">3</span><span class="o">)</span>
<span class="o">(</span><span class="m">3</span>, None<span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="calling-python-functions">
<h2>Calling Python Functions<a class="headerlink" href="#calling-python-functions" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">foo</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">py_callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">rv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;O:callback&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">py_callback</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyCallable_Check</span><span class="p">(</span><span class="n">py_callback</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_TypeError</span><span class="p">,</span> <span class="s">&quot;should be callable&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Make sure we own the GIL</span>
    <span class="n">PyGILState_STATE</span> <span class="n">state</span> <span class="o">=</span> <span class="n">PyGILState_Ensure</span><span class="p">();</span>
    <span class="c1">// similar to py_callback(&quot;Awesome Python!&quot;)</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">PyObject_CallFunction</span><span class="p">(</span><span class="n">py_callback</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;Awesome Python!&quot;</span><span class="p">);</span>
    <span class="c1">// Restore previous GIL state</span>
    <span class="n">PyGILState_Release</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">foo</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span> <span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ python -c <span class="s2">&quot;import foo; foo.foo(print)&quot;</span>
Awesome Python!
</pre></div>
</div>
</div>
<div class="section" id="raise-exception">
<h2>Raise Exception<a class="headerlink" href="#raise-exception" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="n">PyDoc_STRVAR</span><span class="p">(</span><span class="n">doc_mod</span><span class="p">,</span> <span class="s">&quot;Module document</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">PyDoc_STRVAR</span><span class="p">(</span><span class="n">doc_foo</span><span class="p">,</span> <span class="s">&quot;foo() -&gt; None</span><span class="se">\n\n</span><span class="s">Foo doc&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">PyObject</span><span class="o">*</span>
<span class="nf">foo</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span> <span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// raise NotImplementedError</span>
    <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_NotImplementedError</span><span class="p">,</span> <span class="s">&quot;Not implemented&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">foo</span><span class="p">,</span> <span class="n">METH_NOARGS</span><span class="p">,</span> <span class="n">doc_foo</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;Foo&quot;</span><span class="p">,</span> <span class="n">doc_mod</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span> <span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ python -c <span class="s2">&quot;import foo; foo.foo(print)&quot;</span>
$ python -c <span class="s2">&quot;import foo; foo.foo()&quot;</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;&lt;string&gt;&quot;</span>, line <span class="m">1</span>, in &lt;module&gt;
NotImplementedError: Not implemented
</pre></div>
</div>
</div>
<div class="section" id="customize-exception">
<h2>Customize Exception<a class="headerlink" href="#customize-exception" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">FooError</span><span class="p">;</span>

<span class="n">PyDoc_STRVAR</span><span class="p">(</span><span class="n">doc_foo</span><span class="p">,</span> <span class="s">&quot;foo() -&gt; void</span><span class="se">\n\n</span><span class="s">&quot;</span>
    <span class="s">&quot;Equal to the following example:</span><span class="se">\n\n</span><span class="s">&quot;</span>
    <span class="s">&quot;def foo():</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;    raise FooError(</span><span class="se">\&quot;</span><span class="s">Raise exception in C</span><span class="se">\&quot;</span><span class="s">)&quot;</span>
<span class="p">);</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">foo</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">unused</span><span class="p">)))</span>
<span class="p">{</span>
    <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">FooError</span><span class="p">,</span> <span class="s">&quot;Raise exception in C&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">foo</span><span class="p">,</span> <span class="n">METH_NOARGS</span><span class="p">,</span> <span class="n">doc_foo</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="s">&quot;doc&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span> <span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">FooError</span> <span class="o">=</span> <span class="n">PyErr_NewException</span><span class="p">(</span><span class="s">&quot;foo.FooError&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">FooError</span><span class="p">);</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;FooError&quot;</span><span class="p">,</span> <span class="n">FooError</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ python -c <span class="s2">&quot;import foo; foo.foo()&quot;</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;&lt;string&gt;&quot;</span>, line <span class="m">1</span>, in &lt;module&gt;
foo.FooError: Raise exception in C
</pre></div>
</div>
</div>
<div class="section" id="iterate-a-list">
<h2>Iterate a List<a class="headerlink" href="#iterate-a-list" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="cp">#define PY_PRINTF(o) \</span>
<span class="cp">    PyObject_Print(o, stdout, 0); printf(&quot;\n&quot;);</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">iter_list</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">))</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyList_Check</span><span class="p">(</span><span class="n">list</span><span class="p">))</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="c1">// Get iterator</span>
    <span class="n">iter</span> <span class="o">=</span> <span class="n">PyObject_GetIter</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iter</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="c1">// for i in arr: print(i)</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">item</span> <span class="o">=</span> <span class="n">PyIter_Next</span><span class="p">(</span><span class="n">iter</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PY_PRINTF</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">Py_XINCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="nl">error</span><span class="p">:</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;iter_list&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">iter_list</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span> <span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ python -c <span class="s2">&quot;import foo; foo.iter_list([1,2,3])&quot;</span>
<span class="m">1</span>
<span class="m">2</span>
<span class="m">3</span>
</pre></div>
</div>
</div>
<div class="section" id="iterate-a-dictionary">
<h2>Iterate a Dictionary<a class="headerlink" href="#iterate-a-dictionary" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="cp">#define PY_PRINTF(o) \</span>
<span class="cp">    PyObject_Print(o, stdout, 0); printf(&quot;\n&quot;);</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">iter_dict</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">dict</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">o</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">Py_ssize_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dict</span><span class="p">))</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="c1">// for k, v in d.items(): print(f&quot;({k}, {v})&quot;)</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">PyDict_Next</span><span class="p">(</span><span class="n">dict</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">PyUnicode_FromFormat</span><span class="p">(</span><span class="s">&quot;(%S, %S)&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">o</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="n">PY_PRINTF</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="nl">error</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;iter_dict&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">iter_dict</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span> <span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ python -c <span class="s2">&quot;import foo; foo.iter_dict({&#39;k&#39;: &#39;v&#39;})&quot;</span>
<span class="s1">&#39;(k, v)&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="simple-class">
<h2>Simple Class<a class="headerlink" href="#simple-class" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
<span class="p">}</span> <span class="n">FooObject</span><span class="p">;</span>

<span class="cm">/* calss Foo(object): pass */</span>

<span class="k">static</span> <span class="n">PyTypeObject</span> <span class="n">FooType</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyVarObject_HEAD_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">.</span><span class="n">tp_name</span> <span class="o">=</span> <span class="s">&quot;foo.Foo&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_doc</span> <span class="o">=</span> <span class="s">&quot;Foo objects&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_basicsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FooObject</span><span class="p">),</span>
    <span class="p">.</span><span class="n">tp_itemsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_flags</span> <span class="o">=</span> <span class="n">Py_TPFLAGS_DEFAULT</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_new</span> <span class="o">=</span> <span class="n">PyType_GenericNew</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
    <span class="p">.</span><span class="n">m_name</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">m_doc</span> <span class="o">=</span> <span class="s">&quot;module foo&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">m_size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PyType_Ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FooType</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">=</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">Py_XINCREF</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FooType</span><span class="p">);</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">FooType</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ python -q
&gt;&gt;&gt; import foo
&gt;&gt;&gt; print<span class="o">(</span>type<span class="o">(</span>foo.Foo<span class="o">))</span>
&lt;class <span class="s1">&#39;type&#39;</span>&gt;
&gt;&gt;&gt; <span class="nv">o</span> <span class="o">=</span> foo.Foo<span class="o">()</span>
&gt;&gt;&gt; print<span class="o">(</span>type<span class="o">(</span>o<span class="o">))</span>
&lt;class <span class="s1">&#39;foo.Foo&#39;</span>&gt;
&gt;&gt;&gt; class Foo<span class="o">(</span>object<span class="o">)</span>: ...
...
&gt;&gt;&gt; print<span class="o">(</span>type<span class="o">(</span>Foo<span class="o">))</span>
&lt;class <span class="s1">&#39;type&#39;</span>&gt;
&gt;&gt;&gt; <span class="nv">o</span> <span class="o">=</span> Foo<span class="o">()</span>
&gt;&gt;&gt; print<span class="o">(</span>type<span class="o">(</span>o<span class="o">))</span>
&lt;class <span class="s1">&#39;__main__.Foo&#39;</span>&gt;
</pre></div>
</div>
</div>
<div class="section" id="simple-class-with-members-and-methods">
<h2>Simple Class with Members and Methods<a class="headerlink" href="#simple-class-with-members-and-methods" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;structmember.h&gt;</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * class Foo:</span>
<span class="cm"> *     def __new__(cls, *a, **kw):</span>
<span class="cm"> *         foo_obj = object.__new__(cls)</span>
<span class="cm"> *         foo_obj.foo = &quot;&quot;</span>
<span class="cm"> *         foo_obj.bar = &quot;&quot;</span>
<span class="cm"> *         return foo_obj</span>
<span class="cm"> *</span>
<span class="cm"> *     def __init__(self, foo, bar):</span>
<span class="cm"> *         self.foo = foo</span>
<span class="cm"> *         self.bar = bar</span>
<span class="cm"> *</span>
<span class="cm"> *     def fib(self, n):</span>
<span class="cm"> *         if n &lt; 2:</span>
<span class="cm"> *             return n</span>
<span class="cm"> *         return self.fib(n - 1) + self.fib(n - 2)</span>
<span class="cm"> */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">foo</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">bar</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FooObject</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">Foo_dealloc</span><span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">);</span>
    <span class="n">Py_TYPE</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tp_free</span><span class="p">((</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">Foo_new</span><span class="p">(</span><span class="n">PyTypeObject</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kw</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">tp_alloc</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">)</span> <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="cm">/* allocate attributes */</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span> <span class="o">=</span> <span class="n">PyUnicode_FromString</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="n">self</span><span class="o">-&gt;</span><span class="n">bar</span> <span class="o">=</span> <span class="n">PyUnicode_FromString</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bar</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">);</span>
        <span class="n">Py_XINCREF</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">);</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">Foo_init</span><span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kw</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keywords</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">bar</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTupleAndKeywords</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span>
                                    <span class="s">&quot;|OO&quot;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span>
                                    <span class="o">&amp;</span><span class="n">foo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">foo</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">;</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span> <span class="o">=</span> <span class="n">foo</span><span class="p">;</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">;</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">bar</span><span class="p">);</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">bar</span> <span class="o">=</span> <span class="n">bar</span><span class="p">;</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">fib</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">Foo_fib</span><span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;k&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">))</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">PyLong_FromUnsignedLong</span><span class="p">(</span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMemberDef</span> <span class="n">Foo_members</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="n">T_OBJECT_EX</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">FooObject</span><span class="p">,</span> <span class="n">foo</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;bar&quot;</span><span class="p">,</span> <span class="n">T_OBJECT_EX</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">FooObject</span><span class="p">,</span> <span class="n">bar</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">Foo_methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;fib&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">Foo_fib</span><span class="p">,</span> <span class="n">METH_VARARGS</span> <span class="o">|</span> <span class="n">METH_KEYWORDS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">PyTypeObject</span> <span class="n">FooType</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyVarObject_HEAD_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">.</span><span class="n">tp_name</span> <span class="o">=</span> <span class="s">&quot;foo.Foo&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_doc</span> <span class="o">=</span> <span class="s">&quot;Foo objects&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_basicsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FooObject</span><span class="p">),</span>
    <span class="p">.</span><span class="n">tp_itemsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_flags</span> <span class="o">=</span> <span class="n">Py_TPFLAGS_DEFAULT</span> <span class="o">|</span> <span class="n">Py_TPFLAGS_BASETYPE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_new</span> <span class="o">=</span> <span class="n">Foo_new</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_init</span> <span class="o">=</span> <span class="p">(</span><span class="n">initproc</span><span class="p">)</span> <span class="n">Foo_init</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_dealloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">destructor</span><span class="p">)</span> <span class="n">Foo_dealloc</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_members</span> <span class="o">=</span> <span class="n">Foo_members</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_methods</span> <span class="o">=</span> <span class="n">Foo_methods</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PyType_Ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FooType</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">=</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">Py_XINCREF</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FooType</span><span class="p">);</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">FooType</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ python -q
&gt;&gt;&gt; import foo
&gt;&gt;&gt; <span class="nv">o</span> <span class="o">=</span> foo.Foo<span class="o">(</span><span class="s1">&#39;foo&#39;</span>, <span class="s1">&#39;bar&#39;</span><span class="o">)</span>
&gt;&gt;&gt; o.foo
<span class="s1">&#39;foo&#39;</span>
&gt;&gt;&gt; o.bar
<span class="s1">&#39;bar&#39;</span>
&gt;&gt;&gt; o.fib<span class="o">(</span><span class="m">10</span><span class="o">)</span>
<span class="m">55</span>
</pre></div>
</div>
</div>
<div class="section" id="simplie-class-with-getter-and-setter">
<h2>Simplie Class with Getter and Setter<a class="headerlink" href="#simplie-class-with-getter-and-setter" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * class Foo:</span>
<span class="cm"> *     def __new__(cls, *a, **kw):</span>
<span class="cm"> *         foo_obj = object.__new__(cls)</span>
<span class="cm"> *         foo_obj._foo = &quot;&quot;</span>
<span class="cm"> *         return foo_obj</span>
<span class="cm"> *</span>
<span class="cm"> *     def __init__(self, foo=None):</span>
<span class="cm"> *         if foo and isinstance(foo, &#39;str&#39;):</span>
<span class="cm"> *             self._foo = foo</span>
<span class="cm"> *</span>
<span class="cm"> *     @property</span>
<span class="cm"> *     def foo(self):</span>
<span class="cm"> *         return self._foo</span>
<span class="cm"> *</span>
<span class="cm"> *     @foo.setter</span>
<span class="cm"> *     def foo(self, value):</span>
<span class="cm"> *         if not value or not isinstance(value, str):</span>
<span class="cm"> *             raise TypeError(&quot;value should be unicode&quot;)</span>
<span class="cm"> *         self._foo = value</span>
<span class="cm"> */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">foo</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FooObject</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">Foo_dealloc</span><span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">);</span>
    <span class="n">Py_TYPE</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tp_free</span><span class="p">((</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">Foo_new</span><span class="p">(</span><span class="n">PyTypeObject</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kw</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">tp_alloc</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">)</span> <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="cm">/* allocate attributes */</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span> <span class="o">=</span> <span class="n">PyUnicode_FromString</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">);</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">Foo_init</span><span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kw</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keywords</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTupleAndKeywords</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span>
                                    <span class="s">&quot;|O&quot;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span>
                                    <span class="o">&amp;</span><span class="n">foo</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">foo</span> <span class="o">&amp;&amp;</span> <span class="n">PyUnicode_Check</span><span class="p">(</span><span class="n">foo</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">;</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span> <span class="o">=</span> <span class="n">foo</span><span class="p">;</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">Foo_getfoo</span><span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">closure</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">Foo_setfoo</span><span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">closure</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span> <span class="o">||</span> <span class="o">!</span><span class="n">PyUnicode_Check</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_TypeError</span><span class="p">,</span> <span class="s">&quot;value should be unicode&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">);</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyGetSetDef</span> <span class="n">Foo_getsetters</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">getter</span><span class="p">)</span><span class="n">Foo_getfoo</span><span class="p">,</span> <span class="p">(</span><span class="n">setter</span><span class="p">)</span><span class="n">Foo_setfoo</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">PyTypeObject</span> <span class="n">FooType</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyVarObject_HEAD_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">.</span><span class="n">tp_name</span> <span class="o">=</span> <span class="s">&quot;foo.Foo&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_doc</span> <span class="o">=</span> <span class="s">&quot;Foo objects&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_basicsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FooObject</span><span class="p">),</span>
    <span class="p">.</span><span class="n">tp_itemsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_flags</span> <span class="o">=</span> <span class="n">Py_TPFLAGS_DEFAULT</span> <span class="o">|</span> <span class="n">Py_TPFLAGS_BASETYPE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_new</span> <span class="o">=</span> <span class="n">Foo_new</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_init</span> <span class="o">=</span> <span class="p">(</span><span class="n">initproc</span><span class="p">)</span> <span class="n">Foo_init</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_dealloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">destructor</span><span class="p">)</span> <span class="n">Foo_dealloc</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_getset</span> <span class="o">=</span> <span class="n">Foo_getsetters</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PyType_Ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FooType</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">=</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">Py_XINCREF</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FooType</span><span class="p">);</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">FooType</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ python -q
&gt;&gt;&gt; import foo
&gt;&gt;&gt; <span class="nv">o</span> <span class="o">=</span> foo.Foo<span class="o">()</span>
&gt;&gt;&gt; o.foo
<span class="s1">&#39;&#39;</span>
&gt;&gt;&gt; o.foo <span class="o">=</span> <span class="s2">&quot;foo&quot;</span>
&gt;&gt;&gt; o.foo
<span class="s1">&#39;foo&#39;</span>
&gt;&gt;&gt; o.foo <span class="o">=</span> None
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in &lt;module&gt;
TypeError: value should be unicode
</pre></div>
</div>
</div>
<div class="section" id="inherit-from-other-class">
<h2>Inherit from Other Class<a class="headerlink" href="#inherit-from-other-class" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;structmember.h&gt;</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * class Foo:</span>
<span class="cm"> *     def __new__(cls, *a, **kw):</span>
<span class="cm"> *         foo_obj = object.__new__(cls)</span>
<span class="cm"> *         foo_obj.foo = &quot;&quot;</span>
<span class="cm"> *         return foo_obj</span>
<span class="cm"> *</span>
<span class="cm"> *     def __init__(self, foo):</span>
<span class="cm"> *         self.foo = foo</span>
<span class="cm"> *</span>
<span class="cm"> *     def fib(self, n):</span>
<span class="cm"> *         if n &lt; 2:</span>
<span class="cm"> *             return n</span>
<span class="cm"> *         return self.fib(n - 1) + self.fib(n - 2)</span>
<span class="cm"> */</span>

<span class="cm">/* FooObject */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">foo</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FooObject</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">Foo_dealloc</span><span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">);</span>
    <span class="n">Py_TYPE</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tp_free</span><span class="p">((</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">Foo_new</span><span class="p">(</span><span class="n">PyTypeObject</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kw</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">tp_alloc</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">)</span> <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="cm">/* allocate attributes */</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span> <span class="o">=</span> <span class="n">PyUnicode_FromString</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">);</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">Foo_init</span><span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kw</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keywords</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTupleAndKeywords</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="s">&quot;|O&quot;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">foo</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">foo</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">;</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">foo</span> <span class="o">=</span> <span class="n">foo</span><span class="p">;</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">fib</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">Foo_fib</span><span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;k&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">))</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">PyLong_FromUnsignedLong</span><span class="p">(</span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMemberDef</span> <span class="n">Foo_members</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="n">T_OBJECT_EX</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">FooObject</span><span class="p">,</span> <span class="n">foo</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">Foo_methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;fib&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">Foo_fib</span><span class="p">,</span> <span class="n">METH_VARARGS</span> <span class="o">|</span> <span class="n">METH_KEYWORDS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">PyTypeObject</span> <span class="n">FooType</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyVarObject_HEAD_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">.</span><span class="n">tp_name</span> <span class="o">=</span> <span class="s">&quot;foo.Foo&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_doc</span> <span class="o">=</span> <span class="s">&quot;Foo objects&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_basicsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FooObject</span><span class="p">),</span>
    <span class="p">.</span><span class="n">tp_itemsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_flags</span> <span class="o">=</span> <span class="n">Py_TPFLAGS_DEFAULT</span> <span class="o">|</span> <span class="n">Py_TPFLAGS_BASETYPE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_new</span> <span class="o">=</span> <span class="n">Foo_new</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_init</span> <span class="o">=</span> <span class="p">(</span><span class="n">initproc</span><span class="p">)</span> <span class="n">Foo_init</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_dealloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">destructor</span><span class="p">)</span> <span class="n">Foo_dealloc</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_members</span> <span class="o">=</span> <span class="n">Foo_members</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_methods</span> <span class="o">=</span> <span class="n">Foo_methods</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * class Bar(Foo):</span>
<span class="cm"> *     def __init__(self, bar):</span>
<span class="cm"> *         super().__init__(bar)</span>
<span class="cm"> *</span>
<span class="cm"> *     def gcd(self, a, b):</span>
<span class="cm"> *         while b:</span>
<span class="cm"> *             a, b = b, a % b</span>
<span class="cm"> *         return a</span>
<span class="cm"> */</span>

<span class="cm">/* BarObject */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">FooObject</span> <span class="n">super</span><span class="p">;</span>
<span class="p">}</span> <span class="n">BarObject</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">gcd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span><span class="p">;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">Bar_init</span><span class="p">(</span><span class="n">FooObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kw</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">FooType</span><span class="p">.</span><span class="n">tp_init</span><span class="p">((</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">Bar_gcd</span><span class="p">(</span><span class="n">BarObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;kk&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">))</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">PyLong_FromUnsignedLong</span><span class="p">(</span><span class="n">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">Bar_methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;gcd&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">Bar_gcd</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">PyTypeObject</span> <span class="n">BarType</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyVarObject_HEAD_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">.</span><span class="n">tp_name</span> <span class="o">=</span> <span class="s">&quot;foo.Bar&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_doc</span> <span class="o">=</span> <span class="s">&quot;Bar objects&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_basicsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BarObject</span><span class="p">),</span>
    <span class="p">.</span><span class="n">tp_itemsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_flags</span> <span class="o">=</span> <span class="n">Py_TPFLAGS_DEFAULT</span> <span class="o">|</span> <span class="n">Py_TPFLAGS_BASETYPE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FooType</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_init</span> <span class="o">=</span> <span class="p">(</span><span class="n">initproc</span><span class="p">)</span> <span class="n">Bar_init</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_methods</span> <span class="o">=</span> <span class="n">Bar_methods</span>
<span class="p">};</span>

<span class="cm">/* Module */</span>

<span class="k">static</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PyType_Ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FooType</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PyType_Ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BarType</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">=</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">Py_XINCREF</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FooType</span><span class="p">);</span>
    <span class="n">Py_XINCREF</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BarType</span><span class="p">);</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">FooType</span><span class="p">);</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Bar&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">BarType</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py -q build
$ python setup.py -q install
$ python -q
&gt;&gt;&gt; import foo
&gt;&gt;&gt; <span class="nv">bar</span> <span class="o">=</span> foo.Bar<span class="o">(</span><span class="s1">&#39;bar&#39;</span><span class="o">)</span>
&gt;&gt;&gt; bar.foo
<span class="s1">&#39;bar&#39;</span>
&gt;&gt;&gt; bar.fib<span class="o">(</span><span class="m">10</span><span class="o">)</span>
<span class="m">55</span>
&gt;&gt;&gt; bar.gcd<span class="o">(</span><span class="m">3</span>, <span class="m">7</span><span class="o">)</span>
<span class="m">1</span>
</pre></div>
</div>
</div>
<div class="section" id="run-a-python-command">
<h2>Run a Python Command<a class="headerlink" href="#run-a-python-command" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">Py_Initialize</span><span class="p">();</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">PyRun_SimpleString</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">Py_Finalize</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ clang <span class="sb">`</span>python3-config --cflags<span class="sb">`</span> -c foo.c -o foo.o
$ clang <span class="sb">`</span>python3-config --ldflags<span class="sb">`</span> foo.o -o foo
$ ./foo <span class="s2">&quot;print(&#39;Hello Python&#39;)&quot;</span>
Hello Python
</pre></div>
</div>
</div>
<div class="section" id="run-a-python-file">
<h2>Run a Python File<a class="headerlink" href="#run-a-python-file" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">wchar_t</span> <span class="o">**</span><span class="n">argv_copy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyCompilerFlags</span> <span class="n">cf</span> <span class="o">=</span> <span class="p">{.</span><span class="n">cf_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">};</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="c1">// copy argv</span>
    <span class="n">argv_copy</span> <span class="o">=</span> <span class="n">PyMem_RawMalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">wchar_t</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">argc</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv_copy</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">argv_copy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Py_DecodeLocale</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">argv_copy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">continue</span><span class="p">;</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Unable to decode the argument&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Py_Initialize</span><span class="p">();</span>
    <span class="n">Py_SetProgramName</span><span class="p">(</span><span class="n">argv_copy</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">PySys_SetArgv</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv_copy</span><span class="p">);</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">PyRun_AnyFileExFlags</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cf</span><span class="p">);</span>

<span class="nl">error</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argv_copy</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">PyMem_RawFree</span><span class="p">(</span><span class="n">argv_copy</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">PyMem_RawFree</span><span class="p">(</span><span class="n">argv_copy</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">Py_Finalize</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ clang <span class="sb">`</span>python3-config --cflags<span class="sb">`</span> -c foo.c -o foo.o
$ clang <span class="sb">`</span>python3-config --ldflags<span class="sb">`</span> foo.o -o foo
$ <span class="nb">echo</span> <span class="s2">&quot;import sys; print(sys.argv)&quot;</span> &gt; foo.py
$ ./foo foo.py arg1 arg2 arg3
<span class="o">[</span><span class="s1">&#39;./foo&#39;</span>, <span class="s1">&#39;foo.py&#39;</span>, <span class="s1">&#39;arg1&#39;</span>, <span class="s1">&#39;arg2&#39;</span>, <span class="s1">&#39;arg3&#39;</span><span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="import-a-python-module">
<h2>Import a Python Module<a class="headerlink" href="#import-a-python-module" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="cp">#define PYOBJECT_CHECK(obj, label) \</span>
<span class="cp">    if (!obj) { \</span>
<span class="cp">        PyErr_Print(); \</span>
<span class="cp">        goto label; \</span>
<span class="cp">    }</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">program</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">json_module</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">json_dict</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">json_dumps</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">dict</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">program</span> <span class="o">=</span> <span class="n">Py_DecodeLocale</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">program</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;unable to decode the program name&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Py_SetProgramName</span><span class="p">(</span><span class="n">program</span><span class="p">);</span>
    <span class="n">Py_Initialize</span><span class="p">();</span>

    <span class="c1">// import json</span>
    <span class="n">json_module</span> <span class="o">=</span> <span class="n">PyImport_ImportModule</span><span class="p">(</span><span class="s">&quot;json&quot;</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">json_module</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

    <span class="c1">// json_dict = json.__dict__</span>
    <span class="n">json_dict</span> <span class="o">=</span> <span class="n">PyModule_GetDict</span><span class="p">(</span><span class="n">json_module</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">json_dict</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

    <span class="c1">// json_dumps = json.__dict__[&#39;dumps&#39;]</span>
    <span class="n">json_dumps</span> <span class="o">=</span> <span class="n">PyDict_GetItemString</span><span class="p">(</span><span class="n">json_dict</span><span class="p">,</span> <span class="s">&quot;dumps&quot;</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">json_dumps</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

    <span class="c1">// dict = {&#39;foo&#39;: &#39;Foo&#39;, &#39;bar&#39;: 123}</span>
    <span class="n">dict</span> <span class="o">=</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;({sssi})&quot;</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="s">&quot;Foo&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">,</span> <span class="mi">123</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">dict</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

    <span class="c1">// result = json.dumps(dict)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">PyObject_CallObject</span><span class="p">(</span><span class="n">json_dumps</span><span class="p">,</span> <span class="n">dict</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="n">PyObject_Print</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error</span><span class="p">:</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">json_dumps</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">json_dict</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">json_module</span><span class="p">);</span>

    <span class="n">PyMem_RawFree</span><span class="p">(</span><span class="n">program</span><span class="p">);</span>
    <span class="n">Py_Finalize</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ clang <span class="sb">`</span>python3-config --cflags<span class="sb">`</span> -c foo.c -o foo.o
$ clang <span class="sb">`</span>python3-config --ldflags<span class="sb">`</span> foo.o -o foo
$ ./foo
<span class="s1">&#39;{&quot;foo&quot;: &quot;Foo&quot;, &quot;bar&quot;: 123}&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="import-everything-of-a-module">
<h2>Import everything of a Module<a class="headerlink" href="#import-everything-of-a-module" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="cp">#define PYOBJECT_CHECK(obj, label) \</span>
<span class="cp">    if (!obj) { \</span>
<span class="cp">        PyErr_Print(); \</span>
<span class="cp">        goto label; \</span>
<span class="cp">    }</span>


<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">program</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">main_module</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">main_dict</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">uname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">sysname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">program</span> <span class="o">=</span> <span class="n">Py_DecodeLocale</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">program</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;unable to decode the program name&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Py_SetProgramName</span><span class="p">(</span><span class="n">program</span><span class="p">);</span>
    <span class="n">Py_Initialize</span><span class="p">();</span>

    <span class="c1">// import __main__</span>
    <span class="n">main_module</span> <span class="o">=</span> <span class="n">PyImport_ImportModule</span><span class="p">(</span><span class="s">&quot;__main__&quot;</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">main_module</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

    <span class="c1">// main_dict = __main__.__dict__</span>
    <span class="n">main_dict</span> <span class="o">=</span> <span class="n">PyModule_GetDict</span><span class="p">(</span><span class="n">main_module</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">main_dict</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

    <span class="c1">// from os import *</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">PyRun_String</span><span class="p">(</span><span class="s">&quot;from os import *&quot;</span><span class="p">,</span>
                          <span class="n">Py_file_input</span><span class="p">,</span>
                          <span class="n">main_dict</span><span class="p">,</span>
                          <span class="n">main_dict</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">main_dict</span><span class="p">);</span>

    <span class="c1">// uname = __main__.__dict__[&#39;uname&#39;]</span>
    <span class="n">main_dict</span> <span class="o">=</span> <span class="n">PyModule_GetDict</span><span class="p">(</span><span class="n">main_module</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">main_dict</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

    <span class="c1">// result = uname()</span>
    <span class="n">uname</span> <span class="o">=</span> <span class="n">PyDict_GetItemString</span><span class="p">(</span><span class="n">main_dict</span><span class="p">,</span> <span class="s">&quot;uname&quot;</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">uname</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">PyObject_CallObject</span><span class="p">(</span><span class="n">uname</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

    <span class="c1">// sysname = result.sysname</span>
    <span class="n">sysname</span> <span class="o">=</span> <span class="n">PyObject_GetAttrString</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&quot;sysname&quot;</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">sysname</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="n">PyObject_Print</span><span class="p">(</span><span class="n">sysname</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error</span><span class="p">:</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">sysname</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">uname</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">main_dict</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">main_module</span><span class="p">);</span>

    <span class="n">PyMem_RawFree</span><span class="p">(</span><span class="n">program</span><span class="p">);</span>
    <span class="n">Py_Finalize</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ clang <span class="sb">`</span>python3-config --cflags<span class="sb">`</span> -c foo.c -o foo.o
$ clang <span class="sb">`</span>python3-config --ldflags<span class="sb">`</span> foo.o -o foo
$ ./foo
<span class="s1">&#39;Darwin&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="access-attributes">
<h2>Access Attributes<a class="headerlink" href="#access-attributes" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="cp">#define PYOBJECT_CHECK(obj, label) \</span>
<span class="cp">    if (!obj) { \</span>
<span class="cp">        PyErr_Print(); \</span>
<span class="cp">        goto label; \</span>
<span class="cp">    }</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">program</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">json_module</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">json_dumps</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">dict</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">program</span> <span class="o">=</span> <span class="n">Py_DecodeLocale</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">program</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;unable to decode the program name&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Py_SetProgramName</span><span class="p">(</span><span class="n">program</span><span class="p">);</span>
    <span class="n">Py_Initialize</span><span class="p">();</span>

    <span class="c1">// import json</span>
    <span class="n">json_module</span> <span class="o">=</span> <span class="n">PyImport_ImportModule</span><span class="p">(</span><span class="s">&quot;json&quot;</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">json_module</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

    <span class="c1">// json_dumps = json.dumps</span>
    <span class="n">json_dumps</span> <span class="o">=</span> <span class="n">PyObject_GetAttrString</span><span class="p">(</span><span class="n">json_module</span><span class="p">,</span> <span class="s">&quot;dumps&quot;</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">json_dumps</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

    <span class="c1">// dict = {&#39;foo&#39;: &#39;Foo&#39;, &#39;bar&#39;: 123}</span>
    <span class="n">dict</span> <span class="o">=</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;({sssi})&quot;</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="s">&quot;Foo&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">,</span> <span class="mi">123</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">dict</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

    <span class="c1">// result = json.dumps(dict)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">PyObject_CallObject</span><span class="p">(</span><span class="n">json_dumps</span><span class="p">,</span> <span class="n">dict</span><span class="p">);</span>
    <span class="n">PYOBJECT_CHECK</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="n">PyObject_Print</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error</span><span class="p">:</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">json_dumps</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">json_module</span><span class="p">);</span>

    <span class="n">PyMem_RawFree</span><span class="p">(</span><span class="n">program</span><span class="p">);</span>
    <span class="n">Py_Finalize</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ clang <span class="sb">`</span>python3-config --cflags<span class="sb">`</span> -c foo.c -o foo.o
$ clang <span class="sb">`</span>python3-config --ldflags<span class="sb">`</span> foo.o -o foo
$ ./foo
<span class="s1">&#39;{&quot;foo&quot;: &quot;Foo&quot;, &quot;bar&quot;: 123}&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="performance-of-c-extension">
<h2>Performance of C Extension<a class="headerlink" href="#performance-of-c-extension" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">fib</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">fibonacci</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;k&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">))</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">PyLong_FromUnsignedLong</span><span class="p">(</span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;fib&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span><span class="n">fibonacci</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span> <span class="nf">PyInit_foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Compare the performance with pure Python</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">foo</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="n">n</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">time</span><span class="p">();</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fib</span><span class="p">(</span><span class="mi">35</span><span class="p">);</span> <span class="n">e</span> <span class="o">=</span> <span class="n">time</span><span class="p">();</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span>
<span class="go">4.953313112258911</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">time</span><span class="p">();</span> <span class="n">_</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="mi">35</span><span class="p">);</span> <span class="n">e</span> <span class="o">=</span> <span class="n">time</span><span class="p">();</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span>
<span class="go">0.04628586769104004</span>
</pre></div>
</div>
</div>
<div class="section" id="performance-of-ctypes">
<h2>Performance of ctypes<a class="headerlink" href="#performance-of-ctypes" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Compile (Mac)</span>
<span class="c1">// -------------</span>
<span class="c1">//</span>
<span class="c1">//   $ clang -Wall -Werror -shared -fPIC -o libfib.dylib fib.c</span>
<span class="c1">//</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">fib</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Compare the performance with pure Python</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">CDLL</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="n">n</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cfib</span> <span class="o">=</span> <span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;./libfib.dylib&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fib</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">time</span><span class="p">();</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fib</span><span class="p">(</span><span class="mi">35</span><span class="p">);</span> <span class="n">e</span> <span class="o">=</span> <span class="n">time</span><span class="p">();</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span>
<span class="go">4.918856859207153</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">time</span><span class="p">();</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cfib</span><span class="p">(</span><span class="mi">35</span><span class="p">);</span> <span class="n">e</span> <span class="o">=</span> <span class="n">time</span><span class="p">();</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span>
<span class="go">0.07283687591552734</span>
</pre></div>
</div>
</div>
<div class="section" id="ctypes-error-handling">
<h2>ctypes Error handling<a class="headerlink" href="#ctypes-error-handling" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">platform</span><span class="p">,</span> <span class="n">maxsize</span>

<span class="n">is_64bits</span> <span class="o">=</span> <span class="n">maxsize</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span>

<span class="k">if</span> <span class="n">is_64bits</span> <span class="ow">and</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span><span class="p">:</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;libc.dylib&quot;</span><span class="p">,</span> <span class="n">use_errno</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Not support platform: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">platform</span><span class="p">))</span>

<span class="n">stat</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">stat</span>

<span class="k">class</span> <span class="nc">Stat</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From /usr/include/sys/stat.h</span>

<span class="sd">    struct stat {</span>
<span class="sd">        dev_t         st_dev;</span>
<span class="sd">        ino_t         st_ino;</span>
<span class="sd">        mode_t        st_mode;</span>
<span class="sd">        nlink_t       st_nlink;</span>
<span class="sd">        uid_t         st_uid;</span>
<span class="sd">        gid_t         st_gid;</span>
<span class="sd">        dev_t         st_rdev;</span>
<span class="sd">    #ifndef _POSIX_SOURCE</span>
<span class="sd">        struct      timespec st_atimespec;</span>
<span class="sd">        struct      timespec st_mtimespec;</span>
<span class="sd">        struct      timespec st_ctimespec;</span>
<span class="sd">    #else</span>
<span class="sd">        time_t        st_atime;</span>
<span class="sd">        long          st_atimensec;</span>
<span class="sd">        time_t        st_mtime;</span>
<span class="sd">        long          st_mtimensec;</span>
<span class="sd">        time_t        st_ctime;</span>
<span class="sd">        long          st_ctimensec;</span>
<span class="sd">    #endif</span>
<span class="sd">        off_t         st_size;</span>
<span class="sd">        int64_t       st_blocks;</span>
<span class="sd">        u_int32_t     st_blksize;</span>
<span class="sd">        u_int32_t     st_flags;</span>
<span class="sd">        u_int32_t     st_gen;</span>
<span class="sd">        int32_t       st_lspare;</span>
<span class="sd">        int64_t       st_qspare[2];</span>
<span class="sd">    };</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;st_dev&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_ino&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_mode&quot;</span><span class="p">,</span> <span class="n">c_ushort</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_nlink&quot;</span><span class="p">,</span> <span class="n">c_uint</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_uid&quot;</span><span class="p">,</span> <span class="n">c_uint</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_gid&quot;</span><span class="p">,</span> <span class="n">c_uint</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_rdev&quot;</span><span class="p">,</span> <span class="n">c_ulong</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_atime&quot;</span><span class="p">,</span> <span class="n">c_longlong</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_atimendesc&quot;</span><span class="p">,</span> <span class="n">c_long</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_mtime&quot;</span><span class="p">,</span> <span class="n">c_longlong</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_mtimendesc&quot;</span><span class="p">,</span> <span class="n">c_long</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_ctime&quot;</span><span class="p">,</span> <span class="n">c_longlong</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_ctimendesc&quot;</span><span class="p">,</span> <span class="n">c_long</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_size&quot;</span><span class="p">,</span> <span class="n">c_ulonglong</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_blocks&quot;</span><span class="p">,</span> <span class="n">c_int64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_blksize&quot;</span><span class="p">,</span> <span class="n">c_uint32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_flags&quot;</span><span class="p">,</span> <span class="n">c_uint32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_gen&quot;</span><span class="p">,</span> <span class="n">c_uint32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_lspare&quot;</span><span class="p">,</span> <span class="n">c_int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;st_qspare&quot;</span><span class="p">,</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">c_int64</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">]</span>

<span class="c1"># stat success</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;/etc/passwd&quot;</span><span class="p">)</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">Stat</span><span class="p">()</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">byref</span><span class="p">(</span><span class="n">st</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span>

<span class="c1"># if stat fail, check errno</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&amp;%$#@!&quot;</span><span class="p">)</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">Stat</span><span class="p">()</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">byref</span><span class="p">(</span><span class="n">st</span><span class="p">))</span>
<span class="k">if</span> <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">errno</span> <span class="o">=</span> <span class="n">get_errno</span><span class="p">()</span>  <span class="c1"># get errno</span>
    <span class="n">errmsg</span> <span class="o">=</span> <span class="s2">&quot;stat(</span><span class="si">{}</span><span class="s2">) failed. </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">))</span>
    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">)</span>
</pre></div>
</div>
<p>output:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> python err_handling.py   <span class="c1"># python2</span>
<span class="go">Traceback (most recent call last):</span>
<span class="go">  File &quot;err_handling.py&quot;, line 85, in &lt;module&gt;</span>
<span class="go">    raise OSError(errno_, errmsg)</span>
<span class="go">OSError: [Errno 2] stat(&amp;%$#@!) failed. No such file or directory</span>

<span class="gp">$</span> python3 err_handling.py  <span class="c1"># python3</span>
<span class="go">Traceback (most recent call last):</span>
<span class="go">  File &quot;err_handling.py&quot;, line 85, in &lt;module&gt;</span>
<span class="go">    raise OSError(errno_, errmsg)</span>
<span class="go">FileNotFoundError: [Errno 2] stat(b&#39;&amp;%$#@!\x00&#39;) failed. No such file or directory</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo.svg" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=crazyguitar&repo=pysheeet&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<p>This project tries to provide many snippets of Python code that make life easier.</p><h3>Useful Links</h3>
<ul>
  <li><a href="https://www.pythonsheets.com">pysheeet website</a></li>
  <li><a href="https://github.com/crazyguitar/pysheeet">pysheeet @ GitHub</a></li>
  <li><a href="https://github.com/crazyguitar/pysheeet/issues">Issue Tracker</a></li>
  <li><a href="https://media.readthedocs.org/pdf/pysheeet/latest/pysheeet.pdf">pysheeet as a PDF</a></li>
</ul><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7D5K37&placement=wwwpythonsheetscom" id="_carbonads_js"></script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">C Extensions</a><ul>
<li><a class="reference internal" href="#simple-setup-py">Simple setup.py</a></li>
<li><a class="reference internal" href="#customize-cflags">Customize CFLAGS</a></li>
<li><a class="reference internal" href="#doc-string">Doc String</a></li>
<li><a class="reference internal" href="#simple-c-extension">Simple C Extension</a></li>
<li><a class="reference internal" href="#release-the-gil">Release the GIL</a></li>
<li><a class="reference internal" href="#acquire-the-gil">Acquire the GIL</a></li>
<li><a class="reference internal" href="#get-reference-count">Get Reference Count</a></li>
<li><a class="reference internal" href="#parse-arguments">Parse Arguments</a></li>
<li><a class="reference internal" href="#calling-python-functions">Calling Python Functions</a></li>
<li><a class="reference internal" href="#raise-exception">Raise Exception</a></li>
<li><a class="reference internal" href="#customize-exception">Customize Exception</a></li>
<li><a class="reference internal" href="#iterate-a-list">Iterate a List</a></li>
<li><a class="reference internal" href="#iterate-a-dictionary">Iterate a Dictionary</a></li>
<li><a class="reference internal" href="#simple-class">Simple Class</a></li>
<li><a class="reference internal" href="#simple-class-with-members-and-methods">Simple Class with Members and Methods</a></li>
<li><a class="reference internal" href="#simplie-class-with-getter-and-setter">Simplie Class with Getter and Setter</a></li>
<li><a class="reference internal" href="#inherit-from-other-class">Inherit from Other Class</a></li>
<li><a class="reference internal" href="#run-a-python-command">Run a Python Command</a></li>
<li><a class="reference internal" href="#run-a-python-file">Run a Python File</a></li>
<li><a class="reference internal" href="#import-a-python-module">Import a Python Module</a></li>
<li><a class="reference internal" href="#import-everything-of-a-module">Import everything of a Module</a></li>
<li><a class="reference internal" href="#access-attributes">Access Attributes</a></li>
<li><a class="reference internal" href="#performance-of-c-extension">Performance of C Extension</a></li>
<li><a class="reference internal" href="#performance-of-ctypes">Performance of ctypes</a></li>
<li><a class="reference internal" href="#ctypes-error-handling">ctypes Error handling</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016-2020, crazyguitar.
      
      |
      <a href="../_sources/notes/python-c-extensions.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/crazyguitar/pysheeet" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>